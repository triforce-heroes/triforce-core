import{marshall as t,unmarshall as e}from"@aws-sdk/util-dynamodb";import{DDB as i}from"./DDB.js";export class DDBQueryBuilder{constructor(t,e,i,s){this.options={},this.namesIndex=0,this.projections=[],this.attributeNames={},this.attributeValues={},this.keyConditionExpressions=[],this.tableName=t,Object.assign(this.options,s),this.pushKeyConditionExpression(e,"=",i)}pushProjections(...t){this.projections.push(...t.map(t=>this.newAttributeName(t)))}usingIndex(t,e,...i){this.options.IndexName=t,void 0!==e&&this.pushKeyConditionExpression(e,...i)}async get(){let s=[],n={...this.options,TableName:this.tableName,KeyConditionExpression:this.keyConditionExpressions.join(" AND "),...0===this.projections.length?void 0:{ProjectionExpression:this.projections.join(",")},ExpressionAttributeNames:this.attributeNames,ExpressionAttributeValues:t(this.attributeValues)};for(;;){let t=await i().query(n);if(s.push(...t.Items.map(t=>e(t))),t.LastEvaluatedKey){n.ExclusiveStartKey=t.LastEvaluatedKey;continue}break}return s}newAttributeName(t){let e=`#${String(this.namesIndex++)}`;return this.attributeNames[e]=t,e}newAttributeValue(t){let e=`:${String(this.namesIndex++)}`;return this.attributeValues[e]=t,e}pushKeyConditionExpression(t,...e){let i=this.newAttributeName(t);if("BETWEEN"===e[0]){let t=this.newAttributeValue(e[1]),s=this.newAttributeValue(e[2]);this.keyConditionExpressions.push(`${i} BETWEEN ${t} AND ${s}`)}else if("BEGINS_WITH"===e[0]){let t=this.newAttributeValue(e[1]);this.keyConditionExpressions.push(`begins_with(${i},${t})`)}else{let t=this.newAttributeValue(e[1]);this.keyConditionExpressions.push(`${i}${String(e[0])}${t}`)}}}