import{ByteOrder as t}from"./types/ByteOrder.js";import{BufferPolyfill as e}from"./polyfills/BufferPolyfill.js";export class BufferBuilder{constructor(e=t.LITTLE_ENDIAN){this.inBuffers=[],this.deferredCalls=[],this.inLength=0,this.pByteOrder=e}get length(){return this.inLength}build(){for(let t of this.deferredCalls)t();return Buffer.concat(this.inBuffers)}pad(t,e="\0",i=!1){if(!i&&this.inLength%t==0)return this;let r=Buffer.alloc(t-this.inLength%t,e,"binary");return this.inBuffers.push(r),this.inLength+=r.length,this}write(t,e="\0"){if(0!==t){let i=Buffer.from(e.repeat(t));this.inBuffers.push(i),this.inLength+=i.length}return this}writeByte(t){return this.writeUnsignedInt8(t),this}writeInt(e,i=4){let r=Buffer.allocUnsafe(i);return this.pByteOrder===t.LITTLE_ENDIAN?r.writeIntLE(e,0,i):r.writeIntBE(e,0,i),this.inBuffers.push(r),this.inLength+=i,this}writeUnsignedInt(e,i=4){let r=Buffer.allocUnsafe(i);return this.pByteOrder===t.LITTLE_ENDIAN?r.writeUIntLE(e,0,i):r.writeUIntBE(e,0,i),this.inBuffers.push(r),this.inLength+=i,this}writeInt8(t){let e=Buffer.allocUnsafe(1);return this.deferrableCall(e,"writeInt8",t),this.inBuffers.push(e),this.inLength++,this}writeUnsignedInt8(t){let e=Buffer.allocUnsafe(1);return this.deferrableCall(e,"writeUInt8",t),this.inBuffers.push(e),this.inLength++,this}writeInt16(e){let i=Buffer.allocUnsafe(2);return this.deferrableCall(i,this.pByteOrder===t.LITTLE_ENDIAN?"writeInt16LE":"writeInt16BE",e),this.inBuffers.push(i),this.inLength+=2,this}writeUnsignedInt16(e){let i=Buffer.allocUnsafe(2);return this.deferrableCall(i,this.pByteOrder===t.LITTLE_ENDIAN?"writeUInt16LE":"writeUInt16BE",e),this.inBuffers.push(i),this.inLength+=2,this}writeInt32(e){let i=Buffer.allocUnsafe(4);return this.deferrableCall(i,this.pByteOrder===t.LITTLE_ENDIAN?"writeInt32LE":"writeInt32BE",e),this.inBuffers.push(i),this.inLength+=4,this}writeUnsignedInt32(e){let i=Buffer.allocUnsafe(4);return this.deferrableCall(i,this.pByteOrder===t.LITTLE_ENDIAN?"writeUInt32LE":"writeUInt32BE",e),this.inBuffers.push(i),this.inLength+=4,this}writeInt64(i){let r=e.allocUnsafe(8);return this.deferrableCall(r,this.pByteOrder===t.LITTLE_ENDIAN?"writeBigInt64LE":"writeBigInt64BE",i,0n),this.inBuffers.push(r),this.inLength+=8,this}writeUnsignedInt64(i){let r=e.allocUnsafe(8);return this.deferrableCall(r,this.pByteOrder===t.LITTLE_ENDIAN?"writeBigUInt64LE":"writeBigUInt64BE",i,0n),this.inBuffers.push(r),this.inLength+=8,this}writeString(t){if(null!=t&&t.length>0){let e=Buffer.from(t);this.inBuffers.push(e),this.inLength+=e.length}return this}writeLengthPrefixedString(t,e=4){if(null==t||0===t.length)return this.writeUnsignedInt(0,e),this;let i=Buffer.from(t);return this.writeUnsignedInt(i.length,e),this.inBuffers.push(i),this.inLength+=i.length,this}writeMultibytePrefixedString(t){if(null==t||0===t.length)return this.writeByte(0),this;let e=Buffer.from(t),{length:i}=e;for(this.inLength+=i;i>0;){let t=127&i;i>127&&(t|=128),this.writeByte(t),i>>=7}return this.inBuffers.push(e),this}writeNullTerminatedString(t){if(null==t)return this.writeByte(0),this;let e=Buffer.from(t);return this.inBuffers.push(e),this.inLength+=e.length,this.writeByte(0),this}writeFloat(e){let i=Buffer.allocUnsafe(4);return this.deferrableCall(i,this.pByteOrder===t.LITTLE_ENDIAN?"writeFloatLE":"writeFloatBE",e),this.inBuffers.push(i),this.inLength+=4,this}push(...t){return this.inBuffers.push(...t),this.inLength+=t.reduce((t,e)=>t+e.length,0),this}deferrableCall(t,e,i,r=0){let n=t[e].bind(t);if("number"==typeof i||"bigint"==typeof i)n(i);else{let t=this.inLength;this.deferredCalls.push(()=>{n(i(),t)}),n(r)}}}