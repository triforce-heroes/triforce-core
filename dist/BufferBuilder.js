import{ByteOrder as t}from"./types/ByteOrder.js";import{BufferPolyfill as e}from"./polyfills/BufferPolyfill.js";export class BufferBuilder{constructor(e=t.LITTLE_ENDIAN){this.inBuffers=[],this.deferredCalls=[],this.inLength=0,this.littleEndian=e===t.LITTLE_ENDIAN}get length(){return this.inLength}build(){let t=Buffer.concat(this.inBuffers);if(this.deferredCalls.length){let e=this.inBuffers.length;for(let e of this.deferredCalls.reverse())e(t);if(e!==this.inBuffers.length)return Buffer.concat([t,...this.inBuffers.slice(e)])}return t}pad(t,e="\0",r=!1){if(!r&&this.inLength%t==0)return this;let i=Buffer.alloc(t-this.inLength%t,e,"binary");return this.inBuffers.push(i),this.inLength+=i.length,this}write(t,e="\0"){if(0!==t){let r=Buffer.from(e.repeat(t));this.inBuffers.push(r),this.inLength+=r.length}return this}writeByte(t){return this.writeUnsignedInt8(t)}writeInt(t,e=4){return this.writeDeferrableInt(Buffer,e,"writeIntLE","writeIntBE",t)}writeUnsignedInt(t,e=4){return this.writeDeferrableInt(Buffer,e,"writeUIntLE","writeUIntBE",t)}writeInt8(t){return this.writeDeferrableInt(Buffer,1,"writeInt8",void 0,t)}writeUnsignedInt8(t){return this.writeDeferrableInt(Buffer,1,"writeUInt8",void 0,t)}writeInt16(t){return this.writeDeferrableInt(Buffer,2,"writeInt16LE","writeInt16BE",t)}writeUnsignedInt16(t){return this.writeDeferrableInt(Buffer,2,"writeUInt16LE","writeUInt16BE",t)}writeInt32(t){return this.writeDeferrableInt(Buffer,4,"writeInt32LE","writeInt32BE",t)}writeUnsignedInt32(t){return this.writeDeferrableInt(Buffer,4,"writeUInt32LE","writeUInt32BE",t)}writeInt64(t){return this.writeDeferrableInt(e,8,"writeBigInt64LE","writeBigInt64BE",t,0n)}writeUnsignedInt64(t){return this.writeDeferrableInt(e,8,"writeBigUInt64LE","writeBigUInt64BE",t,0n)}writeFloat(t){return this.writeDeferrableInt(Buffer,4,"writeFloatLE","writeFloatBE",t)}writeString(t){if(null!=t&&t.length>0){let e=Buffer.from(t);this.inBuffers.push(e),this.inLength+=e.length}return this}writeLengthPrefixedString(t,e=4){if(null==t||0===t.length)return this.writeUnsignedInt(0,e),this;let r=Buffer.from(t);return this.writeUnsignedInt(r.length,e),this.inBuffers.push(r),this.inLength+=r.length,this}writeMultibytePrefixedString(t){if(null==t||0===t.length)return this.writeByte(0),this;let e=Buffer.from(t),{length:r}=e;for(this.inLength+=r;r>0;){let t=127&r;r>127&&(t|=128),this.writeByte(t),r>>=7}return this.inBuffers.push(e),this}writeNullTerminatedString(t){if(null==t)return this.writeByte(0),this;let e=Buffer.from(t);return this.inBuffers.push(e),this.inLength+=e.length,this.writeByte(0),this}push(...t){return this.inBuffers.push(...t),this.inLength+=t.reduce((t,e)=>t+e.length,0),this}writeDeferrableInt(t,e,r,i,n,s=0){let f=t.allocUnsafe(e),h=this.littleEndian?r:i??r;if("function"==typeof n){let t=this.inLength;this.deferredCalls.push(r=>{r[h](n(),t,e)}),f[h](s,0,e)}else f[h](n,0,e);return this.inBuffers.push(f),this.inLength+=e,this}}